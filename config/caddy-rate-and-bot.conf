{
  # Combined rate limiting and bot protection
  order rate_limit before basicauth
}

http://localhost:8081 {
  encode gzip
  reverse_proxy http://localhost:3000

  # Rate limiting (20 req/s per IP)
  @rateLimited {
    path /api/rate-limit /api/rate-and-bot
  }
  rate_limit @rateLimited {
    key {remote_ip}
    rate 20r/s
  }

  # Bot detection (block curl)
  @bots {
    header User-Agent *curl*
  }
  respond @bots 403 {
    body "Bot Detected"
  }

  # Disable caching
  header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
  header Pragma "no-cache"
  header Expires "0"
}
